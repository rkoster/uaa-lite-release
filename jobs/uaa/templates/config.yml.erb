<% require 'yaml' %>
<%
  def coerce_array(val)
    return [] if val.nil?
    return val if val.is_a?(Array)
    return val.split(',').map(&:strip) if val.is_a?(String)
    begin
      return val.to_a
    rescue
      return [val]
    end
  end

  def ensure_trailing_newline(s)
    return nil if s.nil?
    s = s.to_s.gsub(/\r\n?/, "\n")
    s += "\n" unless s.end_with?("\n")
    s
  end

  cfg = {}

  cfg['server'] = {
    'port' => p('uaa.port'),
    'issuer' => p('uaa.issuer')
  }

  cfg['tls'] = {
    'certificate' => ensure_trailing_newline(p('uaa.tls.certificate')),
    'private_key' => ensure_trailing_newline(p('uaa.tls.private_key'))
  }

  jwt = {}
  jwt['active_key_id'] = p('uaa.jwt.policy.active_key_id')
  keys = {}
  (p('uaa.jwt.policy.keys') || {}).each do |key_id, key_config|
    keys[key_id] = {
      'signing_key' => ensure_trailing_newline(key_config && key_config['signingKey'])
    }
  end
  jwt['keys'] = keys
  jwt['access_token_validity'] = p('uaa.jwt.policy.access_token_validity')
  jwt['refresh_token_validity'] = p('uaa.jwt.policy.refresh_token_validity')
  cfg['jwt'] = jwt

  clients = {}
  (p('uaa.clients') || {}).each do |client_id, client_config|
    c = {}
    c['secret'] = client_config && client_config['secret']
    # Handle both 'authorized_grant_types' and 'authorized-grant-types' (for BOSH ops file compatibility)
    grant_types = client_config && (client_config['authorized_grant_types'] || client_config['authorized-grant-types'])
    c['authorized_grant_types'] = coerce_array(grant_types)
    cs = coerce_array(client_config && client_config['scope'])
    c['scope'] = cs unless cs.empty?
    ca = coerce_array(client_config && client_config['authorities'])
    c['authorities'] = ca unless ca.empty?
    if client_config && client_config['access_token_validity']
      c['access_token_validity'] = client_config['access_token_validity']
    end
    if client_config && client_config['refresh_token_validity']
      c['refresh_token_validity'] = client_config['refresh_token_validity']
    end
    clients[client_id] = c
  end
  cfg['clients'] = clients

  users = {}
  (p('uaa.users') || {}).each do |username, user_config|
    u = {}
    u['password'] = user_config && user_config['password']
    u['email'] = user_config && user_config['email']
    u['groups'] = coerce_array(user_config && user_config['groups'])
    users[username] = u
  end
  cfg['users'] = users
%>
<%= cfg.to_yaml %>
