#!/bin/bash

set -e

RUN_DIR=/var/vcap/sys/run/uaa
LOG_DIR=/var/vcap/sys/log/uaa
PIDFILE=${RUN_DIR}/uaa.pid

mkdir -p ${RUN_DIR} ${LOG_DIR}
chown -R vcap:vcap ${RUN_DIR} ${LOG_DIR}

case $1 in
  start)
    echo "Starting UAA-Lite..."
    
    if [ -f ${PIDFILE} ]; then
      pid=$(cat ${PIDFILE})
      if kill -0 $pid 2>/dev/null; then
        echo "UAA-Lite is already running (pid $pid)"
        exit 0
      fi
      rm -f ${PIDFILE}
    fi
    
    exec chpst -u vcap:vcap \
      /var/vcap/packages/uaa/bin/uaa-lite \
        /var/vcap/jobs/uaa/config/config.yml \
      >> ${LOG_DIR}/uaa.stdout.log \
      2>> ${LOG_DIR}/uaa.stderr.log &
    
    echo $! > ${PIDFILE}
    ;;
    
  stop)
    echo "Stopping UAA-Lite..."
    
    if [ -f ${PIDFILE} ]; then
      pid=$(cat ${PIDFILE})
      if kill -0 $pid 2>/dev/null; then
        kill -TERM $pid
        
        # Wait for process to stop
        for i in $(seq 1 30); do
          if ! kill -0 $pid 2>/dev/null; then
            break
          fi
          sleep 1
        done
        
        # Force kill if still running
        if kill -0 $pid 2>/dev/null; then
          kill -KILL $pid
        fi
      fi
      rm -f ${PIDFILE}
    fi
    ;;
    
  *)
    echo "Usage: ctl {start|stop}"
    exit 1
    ;;
esac
